/*
 * phost.c
 *
 *  Created on: Jul 4, 2024
 *      Author: vital
 */

#include "t818_ff_manager.h"

#define ID_INDEX					2U
#define SPRING_ID					0X01U
#define COSTANT_ID					0X02U
#define GAIN_INDEX					2U
#define COSTANT_LOW_VALUE_INDEX		4U
#define COSTANT_HI_VALUE_INDEX		5U

#define PACKET_SIZE					64U

static const uint8_t configuration_pack1[] = { 0x60, 0x01, 0x04, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static const uint8_t configuration_pack2[] = { 0x60, 0x01, 0x05, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static const uint8_t gain_base[] = { 0x60, 0x02, 0xff, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00 };

static const uint8_t spring[] = { 0x60, 0x00, 0x01, 0x64, 0x66, 0x26, 0x66,
		0x26, 0xff, 0xfe, 0xff, 0xfe, 0xa6, 0x6a, 0xa6, 0x6a, 0xfe, 0xff, 0xfe,
		0xff, 0xfe, 0xff, 0xfe, 0xff, 0xdf, 0x58, 0xa6, 0x6a, 0x06, 0x4f, 0xff,
		0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00 };

static const uint8_t play_effect_base[] = { 0x60, 0x00, 0x01, 0x89, 0x41, 0x01,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00 };

static const uint8_t costant_base[] = { 0x60, 0x00, 0x01, 0x6A, 0xFF, 0xF0,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4F, 0xFF, 0xFF,
		0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00 };

static const uint8_t stop_effect_base[] = { 0x60, 0x00, 0x01, 0x89, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00 };

static const uint8_t set_range[] = { 0x60, 0x08, 0x11, 0x60, 0x54, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

T818_FF_Manager_StatusTypeDef __send_interrupt_data(USBH_HandleTypeDef *phost,
		uint8_t *buff, uint8_t length, uint8_t pipe_index, uint32_t Timeout) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	USBH_URBStateTypeDef urb_status = USBH_URB_ERROR;
	uint32_t stop_time = HAL_GetTick() + Timeout;
	USBH_InterruptSendData(phost, buff, length, pipe_index);
	osDelay(8);
	do {
		urb_status = USBH_LL_GetURBState(phost, pipe_index);
	} while ((urb_status != USBH_URB_DONE) && (urb_status != USBH_URB_IDLE)
			&& (HAL_GetTick() < stop_time));

	if ((urb_status == USBH_URB_DONE) || (urb_status == USBH_URB_IDLE)) {
		status = T818_FF_MANAGER_OK;
	}

	return status;
}

T818_FF_Manager_StatusTypeDef __set_range(USBH_HandleTypeDef *phost) {
	return __send_interrupt_data(phost, (uint8_t*) set_range,
	PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_init(USBH_HandleTypeDef *phost) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	if (phost != NULL) {
		status = T818_FF_MANAGER_OK;

		if ((__send_interrupt_data(phost, (uint8_t*) configuration_pack1,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY)
				!= T818_FF_MANAGER_OK)
				|| (__send_interrupt_data(phost, (uint8_t*) configuration_pack2,
				PACKET_SIZE, T818_FF_MANAGER_FF_PIPE,
				T818_FF_MANAGER_MAX_DELAY) != T818_FF_MANAGER_OK)) {
			status = T818_FF_MANAGER_ERROR;
		}
		if ((t818_ff_manager_set_gain(phost, 0xFF) != T818_FF_MANAGER_OK)
				|| (t818_ff_manager_upload_spring(phost) != T818_FF_MANAGER_OK)
				|| (t818_ff_manager_play_spring(phost) != T818_FF_MANAGER_OK)) {
			status = T818_FF_MANAGER_ERROR;
		}
		if (__set_range(phost) != T818_FF_MANAGER_OK) {
			status = T818_FF_MANAGER_ERROR;
		}

	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_set_gain(
		USBH_HandleTypeDef *phost, uint8_t value) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) gain_base, PACKET_SIZE);
		tx_data[GAIN_INDEX] = value;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_upload_spring(
		USBH_HandleTypeDef *phost) {
	return __send_interrupt_data(phost, (uint8_t*) spring,
	PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_upload_costant(
		USBH_HandleTypeDef *phost, int16_t value) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) costant_base, PACKET_SIZE);
		tx_data[ID_INDEX] = COSTANT_ID;
		tx_data[COSTANT_LOW_VALUE_INDEX] = value & 0X00FF;
		tx_data[COSTANT_HI_VALUE_INDEX] = (value >> 8) & 0X00FF;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_play_spring(
		USBH_HandleTypeDef *phost) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) play_effect_base, PACKET_SIZE);
		tx_data[ID_INDEX] = SPRING_ID;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_play_costant(
		USBH_HandleTypeDef *phost) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) play_effect_base, PACKET_SIZE);
		tx_data[ID_INDEX] = COSTANT_ID;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_stop_spring(
		USBH_HandleTypeDef *phost) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) stop_effect_base, PACKET_SIZE);
		tx_data[ID_INDEX] = SPRING_ID;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

T818_FF_Manager_StatusTypeDef t818_ff_manager_stop_costant(
		USBH_HandleTypeDef *phost) {
	T818_FF_Manager_StatusTypeDef status = T818_FF_MANAGER_ERROR;
	uint8_t tx_data[PACKET_SIZE];
	if (phost != NULL) {
		memcpy(tx_data, (uint8_t*) stop_effect_base, PACKET_SIZE);
		tx_data[ID_INDEX] = COSTANT_ID;
		status = __send_interrupt_data(phost, tx_data,
		PACKET_SIZE, T818_FF_MANAGER_FF_PIPE, T818_FF_MANAGER_MAX_DELAY);
	}
	return status;
}

